name: Build and upload to latest release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          update-environment: true
          cache: 'pipenv'

      - name: Install pipenv
        run: python -m pip install --upgrade pip; pip3 install --user pipenv
        shell: pwsh

      - name: Install dependencies with pipenv
        run: pipenv --python 3.13 && pipenv install --dev
        shell: pwsh

      - name: Build the application
        run: pipenv run pyinstaller --clean --noconfirm --distpath dist tkinter_ui/tkinter_ui.spec
        shell: pwsh

      - name: Check dist exists
        run: |
          if (-not (Test-Path -Path dist)) {
            Write-Error 'dist directory not found. Build failed.'
            exit 1
          }
          Write-Host 'Dist contents:'
          Get-ChildItem -Path dist -Recurse | Select-Object FullName,Length
        shell: pwsh

      - name: Package dist into timestamped zip
        id: package
        run: |
          if (-not (Test-Path -Path version.json)) {
            Write-Error 'version.json not found.'
            exit 1
          }
          $json = Get-Content version.json | ConvertFrom-Json
          $ver = $json.version
          if (-not $ver) { $ver = 'unknown' }
          $repoName = $env:GITHUB_REPOSITORY.Split('/')[1]
          $ts = (Get-Date).ToUniversalTime().AddHours(8).ToString('yyyyMMdd-HHmmss')
          $zipName = "${repoName}-v${ver}-${ts}.zip"
          $zipPath = Join-Path -Path $PWD -ChildPath $zipName
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipPath
          if (-not (Test-Path $zipPath)) {
            Write-Error 'Zip creation failed'
            exit 1
          }
          $size = (Get-Item $zipPath).Length
          if ($size -gt 2147483648) {
            Write-Error "Zip size ($size bytes) exceeds GitHub's 2GB limit. Aborting upload."
            exit 1
          }
          Write-Host "Zip created: $zipPath (size: $size bytes)"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "zip_path=$zipPath"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "zip_name=$zipName"
        shell: pwsh

      - name: Get latest release upload_url
        id: get_latest_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if (-not $env:GITHUB_TOKEN) {
            Write-Error 'GITHUB_TOKEN not available. Set a token with repo access in secrets.RELEASE_PAT or enable permissions.'
            exit 1
          }
          $headers = @{ Authorization = "Bearer $env:GITHUB_TOKEN"; Accept = 'application/vnd.github+json' }
          $apiUrl = "https://api.github.com/repos/$env:GITHUB_REPOSITORY/releases/latest"
          try {
            $release = Invoke-RestMethod -Uri $apiUrl -Headers $headers -UseBasicParsing -ErrorAction Stop
          } catch {
            Write-Error "Failed to get latest release: $($_.Exception.Message)"
            exit 1
          }
          $upload_url = $release.upload_url -replace '\{.*\}$',''
          Write-Host "Latest release id: $($release.id)"
          Write-Host "Upload URL: $upload_url"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "upload_url=$upload_url"
        shell: pwsh

      - name: Upload zip to latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $uploadUrl = "${{ steps.get_latest_release.outputs.upload_url }}"
          $zipPath = "${{ steps.package.outputs.zip_path }}"
          $zipName = "${{ steps.package.outputs.zip_name }}"
          if (-not (Test-Path $zipPath)) {
            Write-Error "Zip not found: $zipPath"
            exit 1
          }
          $uri = "$uploadUrl?name=$zipName"
          Write-Host "Uploading $zipName to $uri"
          $headers = @{ Authorization = "Bearer $env:GITHUB_TOKEN"; Accept = 'application/vnd.github+json' }
          try {
            $bytes = [System.IO.File]::ReadAllBytes($zipPath)
            $resp = Invoke-RestMethod -Uri $uri -Method Post -Body $bytes -Headers $headers -ContentType 'application/zip' -UseBasicParsing -ErrorAction Stop
            Write-Host "Upload successful. Asset id: $($resp.id)"
          } catch {
            Write-Error "Upload failed: $($_.Exception.Message)"
            exit 1
          }
        shell: pwsh

      - name: Confirm upload
        if: ${{ success() }}
        run: |
          Write-Host "Uploaded $(${{ steps.package.outputs.zip_name }}) to the latest release."
        shell: pwsh

